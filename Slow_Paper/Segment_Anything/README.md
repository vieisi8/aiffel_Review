# 학습 내용

---

- Segment Anything

---

## Segment Anything

---

### Abstract

---

  - image segmentation을 위한 새로운 작업, 모델, 데이터 세트인 Segment Anything 프로젝트 소개함
    - 데이터 수집 루프에서 효율적인 모델을 사용해 1,100만개의 라이센스가 있음
    - 개인 정보를 존중하는 이미지에 10억개 이상의 마스크가 포함된 지금따지 가장 큰 규모의 segment 데이터 세트 구축
    - 모델은 즉시 사용 가능하도록 설계 및 학습되어 zero-shot을 새로운 이미지 배포 및 작업에 적용할 수 있음
    - 1B 마스크, 1,100만 개의 이미지로 구성된 SAM(Segment Anything Model)과 상관 데이터 세트(SA-1B)를 [https://segment-anything.com](https://segment-anything.com) 에서 공개하고 있음

---

### 1. Introduction

---

  - 이 프로젝트의 성공은 작업, 모델, 데이터 이 세가지 구성 요성에 달려 있음
  - 이를 개발하기 위해 이미지 세분화에 대한 다음 질문을 해결해야 함
    - zero-shot 일반화를 가능하게 하는 작업은?
    - 해당 모델 아키텍쳐는?
    - 이 작업과 모델을 뒷받침할 수 있는 데이터는?
  - 이러한 질문은 서로 얽혀 있으며 포괄적인 솔루션이 필요함
  - 강력한 사전 교육 목표를 제공하고 다양한 다운스트림 애플리케이션을 지원할 수 있는 만큼 일반적인 promptable segmentation 작업을 정의하는 것으로 시작함
    - 유연한 프롬프트를 지원하고 대화형 사용을 허용하기 위해 프롬프트가 표시되면 실시간으로 segmentation mask를 출력할 수 있는 모델이 필요함
    - 모델을 훈련하려면 다양하고 대규모의 데이터 소스가 필요함
      - segmentation을 위한 웹 규모의 데이터 소스가 없기 때문에
      - 이를 해결하기 위해 '데이터 엔진'을 구축
        - 효율적인 모델을 사용해 데이터 수집 지원
        - 새로 수집한 데이터를 사용해 모델을 개선하는 과정을 반복

---

#### Task

---

  - '프롬프트' 기법을 사용해 zero-shot 및 few-shot 자주 수행할 수 있는 작업 방식에서 영감을 얻음
  - 어떤 segmentation 프롬프트가 주어지면 유효한 segmentation mask를 반환하는 것이 목표인 promptable segmentation 작업을 제안
    - 프롬프트
      - 단순히 이미지에서 분할할 대상을 지정하는 것
      - 물체를 식별하는 공간, 텍스트 정보가 포함될 수 있음
    - 유효한 출력 mask의 요건
      - 프롬프트가 모호하고 여러 개체를 나타낼 수 있는 경우에도, 출력은 적어도 그 중하나에 대한 합리적인 mask여야 한다는 것을 의미함
  - 사전 훈련 목표이자 프롬프트 엔지니어링을 통해 일반적인 다운스트림 segmentation 작업을 해결하는 데 사용됨

---

#### Model

---

  - 프롬프트 가능한 segmentation 작업과 실제 사용이라는 목표
    - 모델 아키텍처에 제약 조건을 부과함
      1. 유연한 프롬프트를 지원해야 함
      2. 능동적인 사용을 위해 실시간으로 mask를 계산해야 함
      3. 모호성을 인식할 수 있어야 함
  1. 강력한 이미지 인코더가 이미지 임베딩 계산
  2. 프롬프트 인코더가 프롬프트를 임베딩 계산
  3. 두 정보 소스를 경량 mask 디코더에 결합
  - 세 가지 제약 조건을 모두 충족하는 간단한 설계 발견
  - 이 모델을 Segment Anything Model 또는 SAM이라고 함
    - 이미지 인코더와 빠은 프롬프트 인코더, mask 디코더로 분리하면 동일한 이미지 임베딩을 다른 프롬프트에 재사용할 수 있음
    - 웹 브라우저에서 50밀리초 이내에 프롬프트에서 mask를 예측
    - 모호성을 인식하도록 하기 위해 하나의 프롬프트에 대해 여러 개의 마스크를 예측하도록 설계 

---

#### Data engine

---

  - 새로운 데이터 분포에 대한 강력한 일반화를 달성하기 위해서는 크고 다양한 mask 세트에 대해 SAM을 훈련 시켜야 한다는 것을 알게 됨
    - mask는 자연적으로 풍부하지 않기 때문에 새로운 전략이 필요했음
  - 우리의 해결책은 "데이터 엔진"을 구축하는 것
    - 즉, 모델 인더 루프 데이터 세트 표기법을 사용해 모델을 공동 개발하는 것
  - 데이터 엔진은 보조 수동, 반자동, 완전 자동의 세 단계로 구성됨
    - 첫 번째 단계
      - SAM이 기존의 대화형 segmentation 설정과 유사하게 어노테이터가 mask에 주석을 달 수 있도록 지원
    - 두 번째 단계
      - SAM이 객체 하위 집합에 대한 마스크를 자동으로 생성해 가능성이 높은 객체 양이온을 표시
      - 주석자는 나머지 객체에 주석을 다는 데 집중
      - mask의 다양성을 높일 수 있음
    - 세 번째 단계
      - SAM에 전경 점의 규칙적인 그리드를 제시해 이미지당 평균 100개의 고품질 mask 생성

---

### 2. Segment Anything Task

---

토큰 사전 딕션 작업을--

#### Model

---

  - 프롬프트 가능한 segmentation 작업과 실제 사용이라는 목표
    - 모델 아키텍처에 제약 조건을 부과함
      1. 유연한 프롬프트를 지원해야 함
      2. 능동적인 사용을 위해 실시간으로 mask를 계산해야 함
      3. 모호성을 인식할 수 있어야 함
  1. 강력한 이미지 인코더가 이미지 임베딩 계산
  2. 프롬프트 인코더가 프롬프트를 임베딩 계산
  3. 두 정보 소스를 경량 mask 디코더에 결합
  - 세 가지 제약 조건을 모두 충족하는 간단한 설계 발견
  - 이 모델을 Segment Anything Model 또는 SAM이라고 함
    - 이미지 인코더와 빠은 프롬프트 인코더, mask 디코더로 분리하면 동일한 이미지 임베딩을 다른 프롬프트에 재사용할 수 있음
    - 웹 브라우저에서 50밀리초 이내에 프롬프트에서 mask를 예측
    - 모호성을 인식하도록 하기 위해 하나의 프롬프트에 대해 여러 개의 마스크를 예측하도록 설계 

---

#### Data engine

---

  - 새로운 데이터 분포에 대한 강력한 일반화를 달성하기 위해서는 크고 다양한 mask 세트에 대해 SAM을 훈련 시켜야 한다는 것을 알게 됨
    - mask는 자연적으로 풍부하지 않기 때문에 새로운 전략이 필요했음
  - 우리의 해결책은 "데이터 엔진"을 구축하는 것
    - 즉, 모델 인더 루프 데이터 세트 표기법을 사용해 모델을 공동 개발하는 것
  - 데이터 엔진은 보조 수동, 반자동, 완전 자동의 세 단계로 구성됨
    - 첫 번째 단계
      - SAM이 기존의 대화형 segmentation 설정과 유사하게 어노테이터가 mask에 주석을 달 수 있도록 지원
    - 두 번째 단계
      - SAM이 객체 하위 집합에 대한 마스크를 자동으로 생성해 가능성이 높은 객체 양이온을 표시
      - 주석자는 나머지 객체에 주석을 다는 데 집중
      - mask의 다양성을 높일 수 있음
    - 세 번째 단계
      - SAM에 전경 점의 규칙적인 그리드를 제시해 이미지당 평균 100개의 고품질 mask 생성

---

### 2. Segment Anything Task

---

  - 토큰 사전 딕션 작업을 foundation model pre-training에 사용하고 신속한 엔지니어링을 통해 다양한 다운스트림 작업을 해결하는 NLP에서 영감을 얻음

---

#### Task

---

  - 프롬프트의 개념을 NLP에서 segmentation으로 변환
    - 여기서 프롬프트는 전경/배경 포인트 세트, 거친 상자 또는 마스크, 자유 형식 텍스트 또는 일반적으로 이미지에서 세그먼트할 대상을 나타내는 모든 정보가 될 수 있음
  - promptable segmentation 작업은 프롬프트가 주어지면 유효한 segmentation mask를 반환하는 것
    - 유효한 mask를 다시 반환한다는 것
      - 프롬프트가 모호하고 여러 개체를 나타낼 수 있는 경우에도 그 중 적어도 하나의 객체에 대해 합리적인 마스크가 출력되어야 한다는 것을 의미
    - 이 요구 사항은 애매한 프롬프트에 대해 일관된 응답을 출력하는 언어 모델을 기대하는 것과 유사함
  - 이 작업을 선택한 이유는 프롬프트를 통해 자연스러운 사전 학습 알고리즘과 다운스트림 segmentation 작업으로의 zero-shot transfer을 위한 일반적인 방법으로 이어지기 때문

---

#### Pre-training

---

  - promptable segmentation 작업은 각 훈련 샘플에 대해 일련의 프롬프트를 시뮬레이션하고 모델의 mask 예측을 기준 진실과 비교하는 자연스러운 사전 훈련 알고리즘을 제안
  - 이 방법은 대화형 segmentation을 채택했지만, 충분한 사용자 입력 후 최종적으로 유효한 mask를 예측하는 것이 목표인 대화형 segmentation과는 달리
    - 프롬프트가 모호한 경우에도 항상 유효한 mask를 예측하는 것이 목표
  - 이를 통해 데이터 엔진에서 다시 요구되는 자동 주석을 포함해 모호성이 포함된 사용 사례에서 사전 학습된 모델을 효과적으로 작동
    - 전문화된 모델링 및 training loss 선택 필요

---

### 3. Segment Anything Model

---

---

#### Resolving ambiguity

---

  - 하나의 출력으모 모호한 프롬프트가 주어지면 모델은 여러 개의 유효한 mask를 예측
    - 이 문제를 해결하기 위해 단일 프롬프트에 대해 여러 출력 mask를 예측하도록 모델 수정
    - 3개의 mask 출력이면 대부분의 일반적인 경우를 처리하기에 충분하다는 것을 발견
      - 중첩 mask는 전체, 부분, 하위 부분으로 최대 3개까지 깊이가 있는 경우가 많음
  - 훈련 중에는 마스크에 대한 최소 손실만 backprop
  - mask의 순위를 매기기 위해 모델은 각 mask에 대한 신뢰도 점수(예상 IoU)를 미리 지정

---

#### Efficiency

---

  - 전반적인 모델 설계는 주로 효율성에 의해 좌우됨
  - 사전 계산된 이미지 임베딩이 주어지면 프롬프트 인코더와 mask 디코더는 웹 브라우저의 CPU에서 50 밀리초 이내레 실행됨
    - 이러한 런타임 성능 덕분에 끊김 없는 실시간 대화형 프롬프트가 가능함

---

#### Losses and training

---

  - focal loss와 dice loss의 선형 조합으로 mask 예측을 감독함
  - 기하학적 프롬프트의 혼합을 사용해 promptable segmentation 작업을 훈련
  - mask당 11라운드에 걸쳐 무작위로 프롬프트를 샘플링해 대화혈 설정을 시뮬레이션하고, 데이터 엔진에 원할하게 통합되도록 SAM을 낮춤

---

### 4. Segment Anything Data Engine

---

  - segmentation mask는 인터넷에 풍부하지 않기 때문에 11억 개의 mask 데이터 세트인 SA-1B를 수집할 수 있도록 데이터 엔진을 구축
  - 데이터 엔진은 세 단계로 구성
    - 모델 지원 수동 주석 단계
    - 자동으로 예측된 마스크와 모델 지원 주석이 혼합된 반자동 단계
    - 주석 입력 없이 모델이 mask를 생성하는 완전 자요 개선 사항이 있었기 때문에 가능
       1. 이전 단계의 다양한 mask를 포함해 모델을 크게 개선할 수 있는 충분한 mask 수집
       2. 모호성 인식 모델을 개발해 모호한 경우에도 유효한 mask를 예측할 수 있게 됨
          - 모호성 인식 모델을 사용하면 점이 부분 또는 하위 부분에 있는 경우
            - 모델이 하위 부분, 부분 및 전체 객체를 반환
          - 모델의 IoU 예측 모듈
            - 신뢰도 높은 mask를 선별해 사용되며, 안정적인 마스크만 식별하고 선택함
              - 확률 맵을 0.5 ~ δ 및0.5 + δ로 임계값을 설정
              - 유사한 마스크가 나오는 경우 안정적인 마스크로 간주
            - 확실하고 안정적인 mask를 선택한 후 비최대 억제(NMS)를 적용해 중복을 필터링
          - 작은 mask의 품질을 다욱 향상시키기 위해 여러 개의 겹쳐진 이미지 크롭도 처리
     - 데이터 세트의 모든 1,100만 개 이미지에 완전 자동 마스크 생성을 적용
       - 총 11억 개의 고품질 mask를 생성 
